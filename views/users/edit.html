<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Halecka - Usuario</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<!-- Meta, title, CSS, favicons, etc. -->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Halecka">

	<%- include ('../partials/styles') %>
	</head>

<body data-mode="edit" data-page="users" data-title="Usuario" data-description=" - Edicion" class="sidebar-mini fixed sidebar-mini-expand-feature skin-black sidebar-collapse">
	<div class="wrapper">
	<%- include ('../partials/topbar') %>
	<%- include ('../partials/sidebar') %>
		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Main content -->
			<section class="content">
				<!-- Info boxes -->
				<div class="row">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div class="box box-success">
							<div class="box-body">
								<form id="companyForm" action="#">
	<h3 data-icon="fa fa-users">Usuario</h3>
	<fieldset>							 
		<input id="device" value="Web" name="device" type="hidden">
		<input id="dialCode" name="dialCode" type="hidden">
		<input id="country" name="country" type="hidden">

		<div class="row">
		<%
		var   avatarLength = collection.avatar.length,
		      indexAvatar = parseInt(collection.avatar.length) - 1,
		      indexAvatarSub,
		      fileAvatar = collection.avatar[indexAvatar];

		if (fileAvatar instanceof Array && typeof fileAvatar.file === 'undefined') {
			indexAvatarSub = parseInt(fileAvatar.length) -1;
			fileAvatar = fileAvatar[indexAvatarSub];
		}
		%>
			<div class="uploadAvatar user-panel align-center">
				<div class="changeAvatar">
		<% if (typeof fileAvatar !== 'undefined') { %>
					<img src="/uploads/<%= fileAvatar.file %>" class="img-circle" style=" width: 15vw !important; height: 15vw !important;" alt="Imagen Empresa">
		<% } else { %>
					<img src="/images/missing-image.jpg" class="img-circle" style=" width: 15vw !important; height: 15vw !important;" alt="Imagen Empresa">
		<% } %>
					<div class="text-center">
						<i class="fa fa-camera"></i>
						<p>Actualizar</p>
					</div>
				</div>
			</div>
			<div class="hidden">
				<label class="form-control-label" for="avatar">Logo</label>
				<div class="input-group">
					<input class="avatar" type="file" id="avatar" data-name="avatar" name="avatar" class="form-control">
				</div>
			</div>
			<div class="col-xs-12">
				<label class="form-control-label" for="username">Nombre de Usuario</label>
				<div class="input-group">
					<input type="text" name="username" value="<%= collection.username %>" id="username" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="firstname">Nombre</label>
				<div class="input-group firstname">
					<input type="text" name="firstname" value="<%= collection.firstname %>" id="firstname" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="lastname">Apellido</label>
				<div class="input-group lastname">
					<input type="text" name="lastname" value="<%= collection.lastname %>" id="lastname" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="email">Correo Electrónico</label>
				<div class="input-group email">
					<input type="email" name="email" value="<%= collection.email %>" id="email" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="phone">Numero de Telefono:</label>
				<div class="input-group phone">
					<input type="tel" name="phone" value="<%= collection.phone %>" id="phone" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="role">Tipo de Usuario</label>
				<div class="input-group">
					<select id="role" name="role" class="form-control">
						<option id="owner" value="owner">Owner</option>
						<option id="admin" value="admin">Admin</option>
						<option id="user" value="user">User</option>
					</select>
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="transportCompany">Empresa de Transporte</label>
				<div class="input-group">
					<select id="transportCompany" name="transportCompany" class="form-control">
					</select>
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="transportGroupName">C&aacute;mara de Transporte</label>
				<div class="input-group transportGroupName">
					<input type="text" name="transportGroupName" value="<%= collection.transportGroupName %>" id="transportGroupName" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="password">Contraseña</label>
				<div class="input-group password">
					<input type="password" id="password" name="password" class="form-control pull-right required">
				</div>
			</div>
			<div class="col-xs-6">
				<label class="form-control-label" for="password-match">Confirmar Contraseña</label>
				<div class="input-group password-match">
					<input type="password" id="password-match" name="password-match" class="form-control pull-right required">
				</div>
			</div>
			<div class="tab-pane col-xs-12 col-sm-12 col-md-12 col-lg-12" style="padding-top: 15px;">
				<div class="row cards newFiles">
				</div>
				<div class="row cards uploadedFiles">
				<%
				if (typeof collection.files !== 'undefined') {

					for(var i=0; i < collection.files.length; i++) {
						collection.files[i].name = collection.files[i].name || collection.files[i].file;
						if (collection.files[i] instanceof Array && typeof collection.files[i] !== 'undefined') {
							for(var index=0; index < collection.files[i].length; index++) {
								collection.files[i][index].name = collection.files[i][index].name || collection.files[i][index].file;
								%>
					<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 userid" data-id="<%= collection.files[i][index]._id %>">
						<div class="card-pf box border-color">
							<div class="box-header text-center">
								<p class="capitalize text-center"><%= collection.files[i][index].filetypes %></p>
								<div class="box-tools pull-right">
									<a class="btn btn-box-tool btn-delete" data-collection="users" data-id="<%= collection.files[i][index]._id %>">
									<i class="fa fa-remove"></i>
									</a>
								</div>
							</div>
							<div class="box-body btn btn-app no-margin fc-grid text-center capitalize">
								<i class="fa fa-file"></i>
								<%= collection.files[i][index].file %></div>
							<div class="box-footer text-center">
								<p class="no-margin capitalize"><%= collection.files[i][index].expiration %></p>
							</div>
						</div>
					</div>
							<%
							}
						} else {
							%>
					<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 userid" data-id="<%= collection.files[i]._id %>">
						<div class="card-pf box border-color">
							<div class="box-header text-center">
								<p class="capitalize text-center"><%= collection.files[i].filetypes %></p>
								<div class="box-tools pull-right">
									<a class="btn btn-box-tool btn-delete" data-collection="users" data-id="<%= collection.files[i]._id %>">
									<i class="fa fa-remove"></i>
									</a>
								</div>
							</div>
							<div class="box-body btn btn-app no-margin fc-grid text-center capitalize">
								<i class="fa fa-file"></i>
								<%= collection.files[i].file %></div>
							<div class="box-footer text-center">
								<p class="no-margin capitalize"><%= collection.files[i].expiration %></p>
							</div>
						</div>
					</div>
					<%
						}
					}
				}
				%>
				</div>
				<div class="row cards uploadedAvatar hidden">
				</div>
			</div>
		</div>
	</fieldset>
								</form>
							</div>
						</div>
					</div>
				</div>
				<!-- /.row -->
			</section>
			<!-- /.content -->
		</div>
		<%- include ('../partials/footer') %>
		<%- include ('../partials/chat') %>
		<div class="chat-sidebar-bg"></div>
		<div class="control-sidebar-bg"></div>

	</div>
	<!-- ./wrapper -->
	<%- include ('../partials/modal') %>
	<%- include ('../partials/compose') %>
	<%- include ('../partials/scripts1') %>
	<!-- <script type="text/javascript" src="/js/ejs.js"></script> -->
	<script type="text/javascript">

	var form = $("#companyForm").show();
	var avatarChanged = false;

	var selectedLinea = $('#parent_linea').data('selected');
	var documents = {};
	documents['filetypes'] = [
		'estatuto',
		'autoridades',
		'fideicomiso',
		'gestion',
		'balance'
	];

	company.getRelated(function(data){
		$.each(data.collection, function (i, item) {
			main.getNotification(item);
		});
	});
	$(document).on('click', '.changeAvatar', function() {
		$('#avatar').trigger('click');
	});
	$(document).on('change', '#avatar', function() {
		main.selectedImage($('#avatar'), $('.uploadAvatar img'));
		avatarChanged = true;
	});
	main.overlay.hide();

	form.steps({
		headerTag: "h3",
		// iconTag: "icon",
		bodyTag: "fieldset",
		transitionEffect: "slideLeft",
		onInit: function (event, currentIndex, newIndex) {
			main.fileOptions(true, documents);
			$('#avatar').on('change', function() {
				main.selectedImage(this, $('.uploadAvatar img'));
			});
		},
		onStepChanging: function (event, currentIndex, newIndex) {
			// Allways allow previous action even if the current form is not valid!
			if (currentIndex > newIndex) {
				return true;
			}
			// Forbid next action on "Warning" step if the user is to young
			if (newIndex === 3 && Number($("#age-2").val()) < 18) {
				return false;
			}
			// Needed in some cases if the user went back (clean up)
			if (currentIndex < newIndex) {
				// To remove error styles
				form.find(".body:eq(" + newIndex + ") label.error").remove();
				form.find(".body:eq(" + newIndex + ") .error").removeClass("error");
			}
			form.validate().settings.ignore = ":disabled,:hidden";
			return form.valid();
		},
		onStepChanged: function (event, currentIndex, priorIndex) {
			// Used to skip the "Warning" step if the user is old enough.
			if (currentIndex === 2 && Number($("#age-2").val()) >= 18) {
				form.steps("next");
			}
			// Used to skip the "Warning" step if the user is old enough and wants to the previous step.
			if (currentIndex === 2 && priorIndex === 3) {
				form.steps("previous");
			}
		},
		onFinishing: function (event, currentIndex) {
			form.validate().settings.ignore = ":disabled";
			return form.valid();
		},
		onFinished: function (e, currentIndex) {
			console.log("Submitted!");
			e.preventDefault();

			(avatarChanged) ? main.uploadAvatar($('#avatar'), 'avatar') : $('#avatar').remove();
			main.uploadFile($('#files'), 'files');

			var serializedArr = $('form').serializeArray();
			var collection = 'users';
			var mode = 'edit';

			main.submit(collection, mode, serializedArr, function (data) {
				console.log(data)
				// socketio.sendNodeNotification(
				// 	'parent_company',
				// 	form.find('#status').val(),
				// 	form.find('#comment').val(),
				// 	'/images/userImage.png',
				// 	'category'
				// );
				main.overlay.fadeOut();
				window.location.href = '/users';
			});

		}
	}).validate({
		errorElement: 'span',
		// errorClass: 'has-error',
		// errorPlacement: function errorPlacement(error, element) { element.after(error); },
		errorPlacement: function errorPlacement(error, element) {
			element.parent().parent().addClass('has-error');
			element.parent().parent().find('label').append(error);
		},
		// messages: {
		// 	'join[email]': "Please enter a valid email address.",
		// 	'firstName': "Please enter a valid first name.",
		// 	'lastName': "Please enter a valid last name."
		// }
		rules: {
			percent: {
				required: true,
				range: [0, 100]
			}
			// confirm: {
			//     equalTo: "#password-2"
			// }
		}
	});
	</script>

	</body>
</html>